{% extends "base.html" %}
{% load cache replays %}

{% block content_primary %}
{% cache 3600 'replay_detail' replay.pk %}

{% if replay.title %}
<div class="row">
    <div class="medium-12 columns">
        <h2>{{ replay.title }}</h2>
        <hr>
    </div>
</div>
{% endif %}

<div class="row">

    <div class="medium-6 columns">
    {% if replay.show_leaderboard %}
        {% scoreboard 0 %}
        {% scoreboard 1 %}
    {% else %}
        <h3>Teams</h3>

        <table width="100%">
            <thead>
                <tr>
                    <th><span class="primary">Blue Team</span></th>
                    <th><span class="secondary">Orange Team</span></th>
                </tr>
            </thead>
            <tbody>
                {% for orange, blue in replay.player_pairs %}
                <tr>
                    <td>
                        {% if orange %}{{ orange }}{% endif %}
                    </td>
                    <td>
                        {% if blue %}{{ blue }}{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if replay.player_set.count != replay.team_sizes|add:replay.team_sizes %}
        <p>
            It looks like there might be some players missing from this list.
            {% if replay.user == user %}
                If you know their names, you can <a href="{% url 'replay:update' pk=replay.pk %}">add them here</a>.
            {% else %}
                <a href="/faqs/">Click here</a> to find out why.</p>
            {% endif %}
        {% endif %}
    {% endif %}
    </div>
    <div class="medium-6 columns">
        <table width="100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Time</th>
                    <th colspan="2">Goal scorer</th>
                </tr>
            </thead>
            <tbody>
                {% for goal in object.goal_set.all %}
                <tr>
                    <td>{{ goal.number }}</td>
                    <td>{{ goal.goal_time }}</td>
                    <td>
                        {% if goal.player.team == 0 %}
                            <span class="primary">{{ goal.player.player_name }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if goal.player.team == 1 %}
                            <span class="secondary">{{ goal.player.player_name }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}

                <tfoot>
                    <td>Total:</td>
                    <td>{{ replay.match_length }}</td>
                    <td>{{ replay.team_0_score }}</td>
                    <td>{{ replay.team_1_score }}</td>
                </tfoot>
            </tbody>
        </table>
    </div>
</div>

<div class="flex-row">
{% for player in replay.player_set.all %}
    {% if player.heatmap %}
        <div class="flex-3">
            <h5 style="margin-bottom: 0;">{{ player.player_name }}</h5>
            <img style="margin-bottom: 20px;" src="{{ player.heatmap.url }}" />
        </div>
    {% endif %}
{% endfor %}
</div>

<div class="row">
    <div class="medium-6 columns">
        {% if replay.user == user %}
        <table width="100%">
            <tbody>
                <tr>
                  <td class="text-center">
                    <a href="{% url 'replay:update' pk=replay.pk %}">
                        {% if replay.title %}
                            Rename this replay
                        {% else %}
                            Give this replay a name
                        {% endif %}
                    </a>
                  </td>
                  <td class="text-center">
                    <a href="{% url 'replay:delete' pk=replay.pk %}" class="alert">Delete this replay</a>
                  </td>
                </tr>
            </tbody>
        </table>
        {% endif %}

        <table width="100%">
            <tbody>
                <tr>
                  <td colspan="2" class="text-center">
                    <a href="{{ replay.file.url }}" target="_blank">Download this replay</a>
                  </td>
                </tr>

                <tr>
                    <td colspan="2">
                        <strong>What do I do once the file has downloaded?</strong>
                        <p>Put the file into your replays folder (found at <code>Documents/My Games/Rocket League/TAGame/Demos</code>), then load up the game and go to the replay listing. The game should appear for viewing.</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="medium-6 columns">
        <table width="100%">
            <tbody>
                <tr>
                    <td>
                        Replay ID:
                    </td>
                    <td>
                        {{ replay.replay_id }}
                    </td>
                </tr>

                <tr>
                    <td>Season:</td>
                    <td>{{ replay.season }}</td>
                </tr>

                <tr>
                    <td>Timestamp:</td>
                    <td>{{ replay.timestamp }}</td>
                </tr>

                <tr>
                    <td>Uploader:</td>
                    <td>
                        {% if replay.user %}
                            <a href="{{ replay.user.profile.get_absolute_url }}">{{ replay.user }}</a>
                        {% else %}
                            {{ replay.player_name }}
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <td>Map name:</td>
                    <td>{{ replay.map }}</td>
                </tr>

                {% if replay.server_name %}
                <tr>
                    <td>Server name:</td>
                    <td>{{ replay.server_name }}</td>
                </tr>
                {% endif %}

                <tr>
                    <td>Game size:</td>
                    <td>{{ replay.team_sizes }}v{{ replay.team_sizes }}</td>
                </tr>

                <tr>
                    <td>Match type:</td>
                    <td>{{ replay.match_type }}</td>
                </tr>

                <tr>
                    <td>Match length:</td>
                    <td>{{ replay.match_length }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endcache %}

<div class="row">
  <div class="medium-12 columns">
    <h3>Discuss this replay</h3>

    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
      this.page.url = 'http{% if request.is_secure %}s{% endif %}://{{ settings.SITE_DOMAIN }}{{ request.path }}';
      this.page.identifier = 'replay_{{ replay.pk }}';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//rlr.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</div>
{% endblock content_primary %}
