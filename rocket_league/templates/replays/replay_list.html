{% extends "base.html" %}
{% load cache pagination %}

{% block content_primary %}
<div class="row">
    <div class="small-12 columns">
        <h3>All replays</h3>
        <p>Below you can find all replays which have been uploaded to {{ settings.SITE_NAME }}.</p>
    </div>
</div>

<div class="row">
    <div class="small-12 columns panel">
        <form action="" method="get">
            {% for field in filter.form %}
                {% if field.name != 'order' %}
                    <div class="medium-3 columns">
                        {{ field.label }}
                        {{ field }}
                    </div>
                {% endif %}
            {% endfor %}

            <div class="medium-12 columns">
                <label>&nbsp;</label>
                <input type="submit" class="button tiny">
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="medium-12 columns text-center">
        <p>{{ page_obj.paginator.count }} replays found.</p>
    </div>
    <div class="medium-12 columns">
        <table width="100%" class="expand">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Map</th>
                    <th>Type</th>
                    <th>Score</th>
                    <th class="orderable" data-order-key="num_frames">
                        Length
                        {% if filter.form.order.value == '-num_frames' %}
                            <em class="icon-down-dir"></em>
                        {% elif filter.form.order.value == 'num_frames' %}
                            <em class="icon-up-dir"></em>
                        {% else %}
                            <em class="icon-sort"></em>
                        {% endif %}
                    </th>
                    <th>Region</th>
                    <th class="orderable" data-order-key="timestamp">
                        Date
                        {% if filter.form.order.value == '-timestamp' %}
                            <em class="icon-down-dir"></em>
                        {% elif filter.form.order.value == 'timestamp' %}
                            <em class="icon-up-dir"></em>
                        {% else %}
                            <em class="icon-sort"></em>
                        {% endif %}
                    </th>
                    <th class="orderable" data-order-key="excitement_factor">
                        Excitement Factor (?)
                        {% if filter.form.order.value == '-excitement_factor' or not filter.form.order.value %}
                            <em class="icon-down-dir"></em>
                        {% elif filter.form.order.value == 'excitement_factor' %}
                            <em class="icon-up-dir"></em>
                        {% else %}
                            <em class="icon-sort"></em>
                        {% endif %}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for replay in object_list %}
                    {% cache 3600 'replay_list_item' replay.pk %}
                        <tr data-href="{{ replay.get_absolute_url }}">
                            <td><a href="{{ replay.get_absolute_url }}">{{ replay }}</a></td>
                            <td>{{ replay.map }}</td>
                            <td>{{ replay.team_sizes }}v{{ replay.team_sizes }}</td>
                            <td><span class="primary">{{ replay.team_0_score }}</span> - <span class="secondary">{{ replay.team_1_score }}</span></td>
                            <td>{{ replay.match_length }}</td>
                            <td>{{ replay.region }}</td>
                            <td>{{ replay.timestamp|date:"jS F, h:iA" }}</td>
                            <td>{{ replay.excitement_factor|floatformat }}</td>
                        </tr>
                    {% endcache %}
                {% empty %}
                <tr>
                    <td colspan="8">There are currently no replays to display. Try adjusting the search options above.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% pagination page_obj %}
    </div>
</div>

<style>
th.orderable {
    cursor: pointer;
}
</style>

<script>
$(function() {
    $('tr[data-href]').on('click', function(e) {
        window.location = $('a[href]:first-of-type', this).attr('href');
        return false;
    });

    $('th.orderable').on('click', function() {
        {% if not filter.form.order.value %}
        if (window.location.search.length > 0) {
            window.location = window.location.href + '&{{ filter.order_by_field }}=-' + $(this).data('order-key');
        } else {
            window.location = window.location.href + '?{{ filter.order_by_field }}=-' + $(this).data('order-key');
        }
        {% else %}
        if ('-' + $(this).data('order-key') === '{{ filter.form.order.value }}') {
            // We're currently ordered by this key descending.
            new_search = window.location.search.replace('{{ filter.order_by_field }}={{ filter.form.order.value }}', '{{ filter.order_by_field }}=' + $(this).data('order-key'))

        } else {
            // We're currently ordered by a different key entirely.
            new_search = window.location.search.replace('{{ filter.order_by_field }}={{ filter.form.order.value }}', '{{ filter.order_by_field }}=-' + $(this).data('order-key'))
        }

        window.location = window.location.pathname + new_search;
        {% endif %}
    });
})
</script>
{% endblock content_primary %}
